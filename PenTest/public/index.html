<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>PenTest Client</title>
</head>

<body>
<!--<p>Click the send button to transmit the text to the WebSocket server. The server will echo back the text.</p>-->
<!--<textarea id="input">Sample Text</textarea>-->
<!--<button onclick="doSend()">Send</button>-->
<canvas id="canvas" width="1132" height="1132" style="width:679px; height:679px; border:1px solid black;"></canvas>
<div id="info" style="display:inline-block;">
    <h2>PenTest</h2>
    updown: <span id="updown">–</span> <br>
    events: <span id="eventCount">–</span> <br>
    <br>
    <b>Connection</b><br>
    info: <span id="connectionInfo">–</span> <br>
    msg: <span id="connectionMsg">–</span> <br>
    <br>
    <b>Pen Status</b><br>
    penStatus: <span id="penStatus">–</span> <br>
<!--    version: <span id="version">–</span> <br>-->
    battLevel: <span id="battLevel">–</span> <br>
    memoryUsed: <span id="memoryUsed">–</span> <br>
    autoPwrOffTime: <span id="autoPwrOffTime">–</span> <br>
    beepOnOff: <span id="beepOnOff">–</span> <br>
    colorState: <span id="colorState">–</span> <br>
    penPressure: <span id="penPressure">–</span> <br>
    pressureMax: <span id="pressureMax">–</span> <br>
    <br>
    <b>Notebook</b><br>
    owner: <span id="ownerId">–</span> <br>
    section: <span id="sectionId">–</span> <br>
    note: <span id="noteId">–</span> <br>
    page: <span id="pageNum">–</span> <br>
    <br>
    <br>
    <button id="clearButton">Clear Page</button> <br>
    <button id="saveButton">Save Data</button> <br>
    <br>
</div>
<div id="output" style="height:300px; overflow-y:scroll; word-wrap:break-word;"></div>

<script language="javascript" type="text/javascript">
    var wsUri = "ws://" + window.location.host;
    var ws;
    var output, input, send;
    var canvas, ctx;
    var lastPos = { x:-1, y:-1 };
    var scale = 10.0;
    var offset = 5.0;
    var lineWidth = 1.0;
    var lineColor = '#fff';
    var bgColor = '#000';

    var logLimit = 10000; // # of characters in console/log
    var events = []; // archive of incoming events/messages (for saving)
    var reconnectTimer = 1000;
    var reconnectAttempt = 0;
    
    function init() {
        output = document.getElementById("output");
        input = document.getElementById("input");
        connectWebSocket();
        setupCanvas();
        document.getElementById("clearButton").addEventListener("click", resetPage);
        document.getElementById("saveButton").addEventListener("click", saveData);
    }

    function connectWebSocket() {
        ws = new WebSocket(wsUri);
        ws.onopen = function(evt) { onOpen(evt) };
        ws.onclose = function(evt) { onClose(evt) };
        ws.onmessage = function(evt) { onMessage(evt) };
        ws.onerror = function(evt) { onError(evt) };
    }

    function reconnect() {
        setTimeout(function() {
            reconnectAttempt++;
            writeToScreen('<span style="color: orange;">RE-CONNECTING (' + reconnectAttempt + ')<\/span>');
            connectWebSocket();
        }, reconnectTimer);
    }

    function onOpen(evt) {
        writeToScreen('<span style="color: green;">CONNECTED<\/span>');
        reconnectAttempt = 0;
    }

    function onClose(evt) {
        writeToScreen('<span style="color: orange;">DISCONNECTED<\/span>');
        reconnect();
    }

    function onMessage(evt) {
        writeToScreen('<span style="color: blue;">RESPONSE:<\/span> ' + evt.data);
        processMessage(evt.data);
    }

    function onError(evt) {
        console.log(evt);
        writeToScreen('<span style="color: red;">ERROR:<\/span> ' + evt.data);
    }

    function doSend() {
        writeToScreen('<span style="color: black;">SENDING:<\/span> ' + input.value);
        websocket.send(input.value);
    }

    function writeToScreen(message) {
        var txt = message + "<br>" + output.innerHTML;
        output.innerHTML = txt.substring(0, logLimit);
    }

    function setupCanvas() {
        canvas = document.getElementById("canvas");
        ctx = canvas.getContext('2d');
        ctx.lineWidth = lineWidth;
        ctx.strokeStyle = lineColor;
        canvas.style.backgroundColor = bgColor;
    }

    function resetPage() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        events = [];
        document.getElementById("eventCount").innerHTML = "–";
        output.innerHTML = '';
    }

    function saveData() {
        var text = JSON.stringify(events);
        text = text.replace(/[}]+,/g, '$&\n'); // insert newline after one ore more '}' followed by ','
        var blob = new Blob([text], {type: 'text/json'});
        var a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = "pentest_" + new Date().toISOString() + ".json";
        a.click();
    }

    function processMessage(text) {
        try {
            var msg = JSON.parse(text);
            events.push(msg);
            document.getElementById("eventCount").innerHTML = events.length;
            
            if (msg.type == "stroke") {
                if (lastPos.x < 0) {
                    lastPos = msg.node;
                }
                ctx.beginPath();
                ctx.moveTo((lastPos.x-offset) * scale, (lastPos.y-offset) * scale);
                ctx.lineTo((msg.node.x-offset) * scale, (msg.node.y-offset) * scale);
                ctx.stroke();
                lastPos = msg.node;
            } else if (msg.type == "updown" ) {
                if (msg.status == "up") {
                    lastPos.x = -1;
                    lastPos.y = -1;
                }
                document.getElementById("updown").innerHTML = msg.status;
            } else if (msg.type == "activeNoteId") {
                document.getElementById("sectionId").innerHTML = msg.sectionId;
                document.getElementById("ownerId").innerHTML = msg.ownerId;
                document.getElementById("noteId").innerHTML = msg.noteId;
                document.getElementById("pageNum").innerHTML = msg.pageNum;
            } else if (msg.type == "connectionStatus") {
                document.getElementById("connectionInfo").innerHTML = msg.info;
                document.getElementById("connectionMsg").innerHTML = msg.msg;
            } else if (msg.type == "penStatus") {
                document.getElementById("penStatus").innerHTML = msg.penStatus;
                //document.getElementById("version").innerHTML = msg.version;
                document.getElementById("battLevel").innerHTML = msg.battLevel;
                document.getElementById("memoryUsed").innerHTML = msg.memoryUsed;
                document.getElementById("autoPwrOffTime").innerHTML = msg.autoPwrOffTime;
                document.getElementById("beepOnOff").innerHTML = msg.beepOnOff;
                document.getElementById("colorState").innerHTML = msg.colorState;
                document.getElementById("penPressure").innerHTML = msg.penPressure;
                document.getElementById("pressureMax").innerHTML = msg.pressureMax;
            } else if (msg.type == "pageChanging") {
                resetPage();
            }
        } catch (err) {
            console.log("Ignoring invalid JSON: " + text);
        }
    }

    window.addEventListener("load", init, false);
    </script>
</body>
</html>
