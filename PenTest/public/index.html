<!DOCTYPE html>
<html lang="en">
<head>
<title>PenTest WebSocket Server</title>
<script language="javascript" type="text/javascript">
	var wsUri = "ws://" + window.location.host;
	var output, input, send;
    var ctx;
    var lastPos = { x:-1, y:-1 };
    var scale = 10.0;
    var offset = 5.0;
    var lineWidth = 1.0;

	function init() {
		output = document.getElementById("output");
		input = document.getElementById("input");
		testWebSocket();
        setupCanvas();
	}

	function testWebSocket() {
		websocket = new WebSocket(wsUri);
		websocket.onopen = function(evt) { onOpen(evt) };
		websocket.onclose = function(evt) { onClose(evt) };
		websocket.onmessage = function(evt) { onMessage(evt) };
		websocket.onerror = function(evt) { onError(evt) };
	}

	function onOpen(evt) {
		writeToScreen('<span style="color: green;">CONNECTED<\/span>');
	}

	function onClose(evt) {
		writeToScreen('<span style="color: orange;">DISCONNECTED<\/span>');
	}

	function onMessage(evt) {
		writeToScreen('<span style="color: blue;">RESPONSE:<\/span> ' + evt.data);
        processMessage(evt.data);
	}

	function onError(evt) {
		writeToScreen('<span style="color: red;">ERROR:<\/span> ' + evt.data);
	}

	function doSend() {
		writeToScreen('<span style="color: black;">SENDING:<\/span> ' + input.value);
		websocket.send(input.value);
	}

	function writeToScreen(message) {
        output.innerHTML = message + "<br>" + output.innerHTML;
	}

    function setupCanvas() {
        var canvas = document.getElementById("canvas");
        ctx = canvas.getContext('2d');
        ctx.lineWidth = lineWidth;
    }

    function processMessage(text) {
        try {
            var msg = JSON.parse(text);
            if (msg.type == "stroke") {
                if (lastPos.x < 0) {
                    lastPos = msg.node;
                }
                ctx.beginPath();
                ctx.moveTo((lastPos.x-offset) * scale, (lastPos.y-offset) * scale);
                ctx.lineTo((msg.node.x-offset) * scale, (msg.node.y-offset) * scale);
                ctx.stroke();
                lastPos = msg.node;
            } else if (msg.type == "updown" && msg.status == "up") {
                lastPos.x = -1;
                lastPos.y = -1;
            }
        } catch (err) {
            console.log("JSON parsing error: " + err.message);
        }
    }

	window.addEventListener("load", init, false);
</script>
</head>

<body>
<h2>PenTest</h2>
<!--<p>Click the send button to transmit the text to the WebSocket server. The server will echo back the text.</p>-->
<!--<textarea id="input">Sample Text</textarea>-->
<!--<button onclick="doSend()">Send</button>-->
<canvas id="canvas" width="800" height="1132" style="width:480px; height:679px; border:1px solid black;"></canvas>
<div id="output" style="height:300px; overflow:scroll;"></div>
</body>
</html>
