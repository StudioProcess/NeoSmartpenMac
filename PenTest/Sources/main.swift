//
//  main.swift
//  PenTest
//
//  Created by Martin Leopold on 10.11.17.
//  Copyright Â© 2017 Process. All rights reserved.
//

import Foundation
import PenLib

let RESET = false

print("Hello, World!")

// setup run loop
var shouldKeepRunning = true
let runLoop = RunLoop.current

var pencomm = NJPenCommManager.sharedInstance()
pencomm?.handleNewPeripheral = nil;
//print("pen comm manager:", pencomm);
print("pen registered:", pencomm?.hasPenRegistered as Any)
print("pen connected: ", pencomm?.isPenConnected as Any)
print("pen uuid: ", pencomm?.regUuid as Any) // works when connected
print("pen connect status", pencomm?.penConnectionStatus as Any)

// Check for reset command line flag
if RESET || (CommandLine.argc >= 2 && CommandLine.arguments[1].lowercased() == "reset") {
    print("RESET PEN REGISTRATION")
    if (pencomm?.hasPenRegistered)! {
        pencomm?.resetPenRegistration()
    }
    exit(0)
}

// spin up websocket server
let server = WebSocketServer_Kitura()
// store some recent pen events to send to new websocket clients
var lastConnectionStatus: String?
var lastPenStatus: String?
var lastNoteId: String?
server.onIncomingConnection() { conn in
    if let connectionStatus = lastConnectionStatus { conn.send(message: connectionStatus) }
    if let penStatus = lastPenStatus { conn.send(message: penStatus) }
    if let noteId = lastNoteId { conn.send(message: noteId) }
}


class PasswordDelegate: NSObject, NJPenPasswordDelegate {
    func penPasswordRequest(_ data: UnsafeMutablePointer<PenPasswordRequestStruct>!) {
        print("HANDLE password:", data)
        pencomm?.setBTComparePassword("0000");
    }
}

class StatusDelegate: NSObject, NJPenStatusDelegate {
    func penStatusData(_ data: UnsafeMutablePointer<PenStateStruct>!) {
        let event = PenStatusEvent(fromPenStateStruct: data.pointee)
        let jsonString = server.broadcast(encodable: event)
        print("HANDLE pen status: \(jsonString)")
        lastPenStatus = jsonString
    }
}

class ParserStartDelegate: NSObject, NJPenCommParserStartDelegate {
    func activeNoteId(forFirstStroke noteId: Int32, pageNum pageNumber: Int32, sectionId section: Int32, ownderId owner: Int32) {
        let event = NoteIdEvent(noteId: noteId, pageNum: pageNumber, sectionId: section, ownerId: owner)
        let jsonString = server.broadcast(encodable: event)
        print("HANDLE active note id (for first stroke): \(jsonString)")
        lastNoteId = jsonString
    }
    
    func setPenCommNoteIdList() {
        print("HANDLE pen comm note id list")
        pencomm?.setAllNoteIdList()
    }
}

class ParserStrokeHandler: NSObject, NJPenCommParserStrokeHandler {
    func processStroke(_ stroke: [AnyHashable : Any]!) {
        let event = StrokeEvent(fromDict: stroke)
        let jsonString = server.broadcast(encodable: event)
        print("HANDLE process stroke: \(jsonString)")
    }
    
    func activeNoteId(_ noteId: Int32, pageNum pageNumber: Int32, sectionId section: Int32, ownderId owner: Int32) {
        let event = NoteIdEvent(noteId: noteId, pageNum: pageNumber, sectionId: section, ownerId: owner)
        let jsonString = server.broadcast(encodable: event)
        print("HANDLE active note id: \(jsonString)")
        lastNoteId = jsonString
    }
    
    func notifyPageChanging() {
        let jsonString = server.broadcast(encodable: PageChangingEvent())
        print("HANDLE page changing: \(jsonString)")
    }
    
    func notifyDataUpdating(_ updating: Bool) {
        print("HANDLE data updating")
    }
    
    func setPenColor() -> UInt32 {
        print("HANDLE set pen color")
        return 0;
    }
}

// event.info contains the connection status
// 0 .. None
// 1 .. ScanStarted
// 2 .. Connected
// 3 .. Disconnected
func penConnectionStatusChange(notification: Notification) {
    let event = ConnectionStatusEvent(fromDict: notification.userInfo!)
    let jsonString = server.broadcast(encodable: event)
    print("CONNECTION status change: \(jsonString)")
    lastConnectionStatus = jsonString
    
    // on connection
    if event.info == 2 {
//        pencomm?.setPenState()
        pencomm?.setPenStateWithAutoPwrOffTime(UInt16.max) // auto power off time in minutes
//        pencomm?.setPenStateWithRGB(0)
//        pencomm?.setPenStateWithPenPressure(128);
    }
    // retry connection when disconnected
    else if event.info == 3 {
        pencomm?.btStart()
    }
}

NotificationCenter.default.addObserver(
    forName: NSNotification.Name.NJPenCommManagerPenConnectionStatusChange,
    object: nil, queue: nil,
    using: penConnectionStatusChange)


let passwordDelegate = PasswordDelegate()
pencomm?.setPenPasswordDelegate( passwordDelegate )

let statusDelegate = StatusDelegate()
pencomm?.setPenStatusDelegate( statusDelegate )

let parserStartDelegate = ParserStartDelegate()
pencomm?.setPenCommParserStartDelegate( parserStartDelegate )

let parserStrokeHandler = ParserStrokeHandler()
pencomm?.setPenCommParserStrokeHandler( parserStrokeHandler )

pencomm?.btStart()

// start the run loop
while shouldKeepRunning == true &&
    runLoop.run(mode: RunLoopMode.defaultRunLoopMode, before: NSDate.distantFuture) {}
